<?phpsession_start();if (isset($_SESSION["login"]) && $_SESSION["login"] == "ok") {?><?phpinclude ("../header.php");                                                      // Header Ladeninclude ("../../configuration.php");                                            // Konfiguration Ladeninclude ("../../funktionen.php");                                               // Funktionen Ladeninclude ("menu.php");                                                           // Menü Laden                                   // Uebergabe von Daten mittels GET UND POSTif (!isset($_POST["step"])) {    $step = "1";} else {    $step = $_POST["step"];}$set_stationid = $_POST["set_stationid"];$set_type = $_POST["set_type"];$set_standort = $_POST["set_standort"];$set_ip = $_POST["set_ip"];$set_port = $_POST["set_port"];$set_user = $_POST["set_user"];$set_pass = $_POST["set_pass"];$set_beschreibung = $_POST["set_beschreibung"];if (isset($_POST["set_script"])) {    $set_script = $_POST["set_script"];//    if (preg_match('~^[A-Za-z0-9_]+.php~', $set_script) != "1") {//        echo "Path Traversal Attack detected!";//        exit;//    };};$station = $_POST["station"];$set_aktiv = "1";                                                               // Station Protokoll ist aktiv$set_objektid = $_POST["set_objektid"];$set_sendcommand = $_POST["set_sendcommand"];$set_receivefilter = $_POST["set_receivefilter"];$set_recievecommand = $_POST["set_recievecommand"];$set_parameter1 = $_POST["set_parameter1"];$set_parameter2 = $_POST["set_parameter2"];$set_parameter3 = $_POST["set_parameter3"];$set_intervall_time = $_POST["set_intervall_time"];$set_prioritaet = $_POST["set_prioritaet"];if ($step == "1") {    echo '<table border="0" width="100%">';    echo '<tr><td colspan="2">';    echo "<FONT SIZE=+2>Einrichtung eines neuen Daemon Jobs<br></font>";    echo "Schritt 1 von 5...<br><br>";    echo '</td></tr>';    echo '<tr><td valign="top">';    echo "Wählen Sie zunächst aus,<br> ob Sie neue Verbindungsdaten einer Station eingeben,<br> oder die Daten einer bereits vorhandenen Station verwenden wollen. Da nicht immer eine Station benötigt wird, können Sie auch sagen, dass Sie keine verwenden möchten.<br><br>";    echo '<form action="' . $_SERVER['PHP_SELF'] . '" method="POST">';    echo '<input type="hidden" name="step" value="2" />';    echo '<input type="hidden" name="station" value="new" />';    echo '<label for="submit">&nbsp;</label>';    echo '<input type="submit" id="submit" name="submit" value="Neue Station Anlegen" class="button" />';    echo '</form>';        echo '<form action="' . $_SERVER['PHP_SELF'] . '" method="POST">';    echo '<input type="hidden" name="step" value="2" />';    echo '<input type="hidden" name="station" value="existing" />';    echo '<label for="submit">&nbsp;</label>';    echo '<input type="submit" id="submit" name="submit" value="Vorhandene Station nutzen" class="button" />';    echo '</form>';        echo '<form action="' . $_SERVER['PHP_SELF'] . '" method="POST">';    echo '<input type="hidden" name="step" value="2" />';    echo '<input type="hidden" name="station" value="keine" />';    echo '<label for="submit">&nbsp;</label>';    echo '<input type="submit" id="submit" name="submit" value="Ohne eine Station (Nur ein Job)" class="button" />';    echo '</form>';        echo "</td></tr></table>";};if ($step == "2") {    echo '<table border="0" width="100%">';    echo '<tr><td colspan="2">';    echo "<FONT SIZE=+2>Einrichtung eines neuen Daemon Jobs<br></font>";    echo "Schritt 2 von 5...<br><br>";    echo '</td></tr>';    echo '<tr><td valign="top">';        if ($station == "new") {        echo "Bitte geben Sie die Verbindungsdaten zu Ihrer neuen Station ein,<br> an der die Sensoren angeschlossen sind.<br><br>";        echo '<form action="' . $_SERVER['PHP_SELF'] . '" method="POST">';        echo '<table border="0" cellpadding="0" cellspacing="0">';        echo '<tr><td><label for="set_standort">Standort:</label></td><td>';        echo '<input type="text" id="set_standort" name="set_standort"></td></tr>';                echo '<tr><td><label for="set_ip">IP:</label></td><td>';        echo '<input type="text" id="set_ip" name="set_ip"></td></tr>';        echo '<tr><td><label for="set_port">PORT:</label></td><td>';        echo '<input type="text" id="set_port" name="set_port"></td></tr>';        echo '<tr><td><label for="set_user">Benutzer:</label></td><td>';        echo '<input type="text" id="set_user" name="set_user"></td></tr>';        echo '<tr><td><label for="set_pass">Passwort:</label></td><td>';        echo '<input type="text" id="set_pass" name="set_pass"></td></tr>';        echo '</tr></td><tr><td colspan="2">';        echo '<div align="right"><br>';        echo '<input type="hidden" name="step" value="2" />';        echo '<input type="hidden" name="station" value="making" />';        echo '<label for="submit">&nbsp;</label>';        echo '<input type="submit" id="submit" name="submit" value="Weiter zu Schritt 3" class="button" />';        echo '</form>';        echo '</td></tr></table>';    } elseif ($station == "making") {        //echo "Der Eintrag in der Datenbank wird nun erstellt...<br>";        $sql_neu = "INSERT INTO `stationen` (`standort`, `ip`, `port`, `user`, `pass`) VALUES ('" . $set_standort . "', '" . $set_ip . "', '" . $set_port . "', '" . $set_user . "', '" . $set_pass . "')";        if (mysql_query($sql_neu, $link)) {                echo "Die Daten wurden erfolgreich in die Datenbank eingetragen.<br><br>";            $mysqlid = mysql_insert_id();                        echo "Hier noch einmal die Daten im Ueberblick: ";            echo '<table border="1">';            echo '<tr><td><label for="set_standort">ID Der Datenbank:</label></td><td>';            echo $mysqlid . "&nbsp;";            echo '</td></tr>';                        echo '<tr><td><label for="set_standort">Standort:</label></td><td>';            echo $set_standort . "&nbsp;";            echo '</td></tr>';            echo '<tr><td><label for="set_ip">IP:</label></td><td>';            echo $set_ip . "&nbsp;";            echo '</td></tr>';            echo '<tr><td><label for="set_port">PORT:</label></td><td>';            echo $set_port . "&nbsp;";            echo '</td></tr>';            echo '<tr><td><label for="set_user">Benutzer:</label></td><td>';            echo $set_user . "&nbsp;";            echo '</td></tr>';            echo '<tr><td><label for="set_pass">Passwort:</label></td><td>';            echo $set_pass . "&nbsp;";            echo '</td></tr>';            echo '</td></tr></table><br>';                                    echo '<form action="' . $_SERVER['PHP_SELF'] . '" method="POST">';            echo '<input type="hidden" name="step" value="3" />';            echo '<input type="hidden" name="set_stationid" value="' . $mysqlid . '" />';            echo '<label for="submit">&nbsp;</label>';            echo '<input type="submit" id="submit" name="submit" value="Weiter zu Schritt 3" class="button" />';            echo '</form>';        } else {            echo '<dl id="system-message"><dd class="message message fade error"><ul><li>Die Daten konnten nicht in die Datenbank geschrieben werden!</li><li>';            echo mysql_error($link); // Fehler Posten            echo "</li></ul></dd></dl>";        };    } elseif ($station == "existing") {        echo "Bitte wählen Sie aus der Liste der vorhandenen Stationen die gewünschte Station aus.<br><br>";        echo '<form action="' . $_SERVER['PHP_SELF'] . '" method="POST">';        echo '<input type="hidden" name="step" value="3" />';        echo '<select id="set_stationid" name="set_stationid">';        $mysqlreq = "SELECT * FROM stationen";        $result = mysql_query($mysqlreq);        while ($row = mysql_fetch_array($result)) {            echo '<option value=' . $row["ID"] . '>' . $row["standort"] . ' (IP=' . $row["ip"] . ', PORT=' . $row["port"] . ')</option>';        };        echo '</select>';        echo '<label for="submit">&nbsp;</label>';        echo '<input type="submit" id="submit" name="submit" value="Senden" class="button" />';        echo '</form>';    } elseif ($station == "keine") {        echo "Sie haben ausgewählt, dass keine Station verwendet werden soll. Bitte einfach auf Senden klicken!<br><br>";        echo '<form action="' . $_SERVER['PHP_SELF'] . '" method="POST">';        echo '<input type="hidden" name="step" value="3" />';        echo '<input type="hidden" name="set_stationid" value="NULL" />';        echo '<label for="submit">&nbsp;</label>';        echo '<input type="submit" id="submit" name="submit" value="Senden" class="button" />';        echo '</form>';    } else {        echo "Error";    };        echo "</td></tr></table>";};if ($step == "3") {    echo '<table border="0" width="100%">';    echo '<tr><td colspan="2">';    echo "<FONT SIZE=+2>Einrichtung eines neuen Daemon Jobs<br></font>";    echo "Schritt 3 von 5...<br><br>";    echo '</td></tr>';    echo '<tr><td valign="top">';        echo "Verbindungsdaten zur Station:";    echo '<form action="' . $_SERVER['PHP_SELF'] . '" method="POST">';    echo '<input type="hidden" name="step" value="4" />';    echo '<input type="hidden" name="set_stationid" value="' . $set_stationid . '" />';        $mysqlreq = "SELECT * FROM stationen WHERE " . $set_stationid . " = ID";    $result = mysql_query($mysqlreq);    while ($row = mysql_fetch_array($result)) {        echo '<table border="1">';        echo '<tr><td><label for="id">ID Der Datenbank:</label></td><td>';        echo $row["ID"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="standort">Standort:</label></td><td>';        echo $row["standort"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="ip">IP:</label></td><td>';        echo $row["ip"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="port">PORT:</label></td><td>';        echo $row["port"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="user">Benutzer:</label></td><td>';        echo $row["user"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="pass">Passwort:</label></td><td>';        echo $row["pass"] . "&nbsp;";        echo '</td></tr>';        echo '</td></tr></table><br>';      };    echo '<table border="0">';        echo '<tr><td><label for="set_type">Type:</label></td><td>';    echo '<select id="set_type" style="width:100%" name="set_type">';    echo '<option value="0">Station</OPTION>';//    echo '<option value="1">Aktor</option>';    echo '<option value="2">PHP Job</option>';    echo '</select></td></tr>';     echo '</td></tr></table><br>';        echo '<label for="submit">&nbsp;</label>';    echo '<input type="submit" id="submit" name="submit" value="Weiter zu Schritt 4" class="button" />';    echo '</form>';        echo "</td></tr></table>";};if ($step == "4") {    echo '<table border="0" width="100%">';    echo '<tr><td colspan="2">';    echo "<FONT SIZE=+2>Einrichtung eines neuen Daemon Jobs<br></font>";    echo "Schritt 4 von 5...<br><br>";    echo '</td></tr>';    echo '<tr><td valign="top">';        echo "Verbindungsdaten zur Station:";    echo '<form action="' . $_SERVER['PHP_SELF'] . '" method="POST">';    echo '<input type="hidden" name="step" value="5" />';    echo '<input type="hidden" name="set_stationid" value="' . $set_stationid . '" />';    echo '<input type="hidden" name="set_type" value="' . $set_type . '" />';        $mysqlreq = "SELECT * FROM stationen WHERE " . $set_stationid . " = ID";    $result = mysql_query($mysqlreq);    while ($row = mysql_fetch_array($result)) {        echo '<table border="1">';        echo '<tr><td><label for="id">ID Der Datenbank:</label></td><td>';        echo $row["ID"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="standort">Standort:</label></td><td>';        echo $row["standort"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="ip">IP:</label></td><td>';        echo $row["ip"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="port">PORT:</label></td><td>';        echo $row["port"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="user">Benutzer:</label></td><td>';        echo $row["user"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="pass">Passwort:</label></td><td>';        echo $row["pass"] . "&nbsp;";        echo '</td></tr>';        echo '</td></tr></table><br>';      };    echo "Protokoll Einstellungen:";    echo '<table border="1">';        echo '<tr><td><label for="set_type">Type:</label></td><td>';    if ($set_type == "0") {        echo "Station";//    } elseif ($set_type == "1") {//        echo "Aktor";    } elseif ($set_type == "2") {         echo "PHP Job";    };    echo '</td></tr>';           echo "</table><br>";            echo '<table border="0">';    echo '<tr><td><label for="set_beschreibung">Beschreibung:</label></td><td>';    echo '<input type="text" size="30px" id="set_beschreibung" name="set_beschreibung"></td></tr>';        echo '<tr><td><label for="set_script">Script:</label></td><td>';    echo '<select id="set_script" style="width:100%" name="set_script">';    // Daemon Script    if ($set_type == "0") {        $daemonscriptordner = "sensoren";//    } elseif ($set_type == "1") {//        $daemonscriptordner = "aktoren";    } elseif ($set_type == "2") {         $daemonscriptordner = "andere";    };    $daemonscriptpfad = $absolut_pfad . "/daemon/" . $daemonscriptordner . "/";    $daemonprotokolle = opendir($daemonscriptpfad);    while($daemonprotokollelist = readdir($daemonprotokolle)) {        if ( !is_dir($daemonprotokollelist) and $daemonprotokollelist != "index.php" and $daemonprotokollelist != "telnetconnector.php" and $daemonprotokollelist != "telnetconnector_ethersex.php" ) {            if ($row["script"] != $daemonprotokollelist) {                echo '<option value=' . $daemonprotokollelist . '>' . $daemonprotokollelist . '</option>';            } else {                echo '<option SELECTED value=' . $daemonprotokollelist . '>' . $daemonprotokollelist . '</option>';            };        };    };    closedir($daemonprotokolle);      echo '</select></td></tr>';      echo '</td></tr></table><br>';        echo '<label for="submit">&nbsp;</label>';    echo '<input type="submit" id="submit" name="submit" value="Weiter zu Schritt 5" class="button" />';    echo '</form>';        echo "</td></tr></table>";};if ($step == "5") {    echo '<table border="0" width="100%">';    echo '<tr><td colspan="2">';    echo "<FONT SIZE=+2>Einrichtung eines neuen Daemon Jobs<br></font>";    echo "Schritt 5 von 5...<br><br>";    echo '</td></tr>';    echo '<tr><td valign="top">';        echo "Verbindungsdaten zur Station:";    echo '<form action="' . $_SERVER['PHP_SELF'] . '" method="POST">';    echo '<input type="hidden" name="step" value="6" />';            echo '<input type="hidden" name="set_stationid" value="' . $set_stationid . '" />';    echo '<input type="hidden" name="set_type" value="' . $set_type . '" />';    echo '<input type="hidden" name="set_beschreibung" value="' . $set_beschreibung . '" />';    echo '<input type="hidden" name="set_script" value="' . $set_script . '" />';    $mysqlreq = "SELECT * FROM stationen WHERE " . $set_stationid . " = ID";    $result = mysql_query($mysqlreq);    while ($row = mysql_fetch_array($result)) {        echo '<table border="1">';        echo '<tr><td><label for="id">ID Der Datenbank:</label></td><td>';        echo $row["ID"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="standort">Standort:</label></td><td>';        echo $row["standort"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="ip">IP:</label></td><td>';        echo $row["ip"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="port">PORT:</label></td><td>';        echo $row["port"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="user">Benutzer:</label></td><td>';        echo $row["user"] . "&nbsp;";        echo '</td></tr>';        echo '<tr><td><label for="pass">Passwort:</label></td><td>';        echo $row["pass"] . "&nbsp;";        echo '</td></tr>';                echo '</td></tr></table><br>';      };    echo "Protokoll Einstellungen:";    echo '<table border="1">';        echo '<tr><td><label for="set_type">Type:</label></td><td>';    if ($set_type == "0") {        echo "Sensor";        $daemonscriptordner = "sensoren";//    } elseif ($set_type == "1") {//        echo "Aktor";//        $daemonscriptordner = "aktoren";    } elseif ($set_type == "2") {         echo "Other";        $daemonscriptordner = "andere";    };    echo '</td></tr>';        echo '<tr><td><label for="set_beschreibung">Beschreibung:</label></td><td>';    echo $set_beschreibung . "&nbsp;";    echo '</td></tr>';        echo '<tr><td><label for="set_script">Script:</label></td><td>';    echo $set_script . "&nbsp;";    echo '</td></tr>';       echo "</table><br>";    echo '<table border="0">';        function funktion_sensorsystemauswertung($set_script,$daemonscriptordner) {        include ("../../daemon/" . $daemonscriptordner . "/" . $set_script);        return $station_protokoll_objektid_generieren;    };        if (funktion_sensorsystemauswertung($set_script,$daemonscriptordner) == "1") {        echo "<b>INFO:</b> Das von ihnen gewaehlte Script benoetigt eine feste SensorID.";        echo "<br>Eine entsprechende SensorID wurde generiert und in das Feld eingetragen!<br><br>";                //MAMS-b3812a5104b17f1ca31a683662e        $get_objektid = "MAMS-" . sha1(mt_rand(10000,99999).time());        $get_objektid = substr($get_objektid, 0, 25);    };        echo 'Protokoll Einstellungen - Optional:';            echo '<tr><td><label for="set_objektid">objektid:</label></td><td>';                            // generieren für bestimmte sensoren??    echo '<input type="text" size="30px" id="set_objektid" name="set_objektid" value="' . $get_objektid . '"></td></tr>';        echo '<tr><td><label for="set_sendcommand">SEND-Command:</label></td><td>';    echo '<input type="text" size="30px" id="set_sendcommand" name="set_sendcommand"></td></tr>';        echo '<tr><td><label for="set_receivefilter">RECV-Filter:</label></td><td>';    echo '<input type="text" size="30px" id="set_receivefilter" name="set_receivefilter"></td></tr>';    echo '<tr><td><label for="set_recievecommand">RECV-Command:</label></td><td>';    echo '<input type="text" size="30px" id="set_recievecommand" name="set_recievecommand"></td></tr>';    echo '<tr><td><label for="set_parameter1">Parameter 1:</label></td><td>';    echo '<input type="text" size="30px" id="set_parameter1" name="set_parameter1"></td></tr>';        echo '<tr><td><label for="set_parameter2">Parameter 2:</label></td><td>';    echo '<input type="text" size="30px" id="set_parameter2" name="set_parameter2"></td></tr>';        echo '<tr><td><label for="set_parameter3">Parameter 3:</label></td><td>';    echo '<input type="text" size="30px" id="set_parameter3" name="set_parameter3"></td></tr>';        echo '</td></tr><tr><td colspan="2"><br>';    echo 'Queue Einstellungen - Optional:';            echo '<tr><td><label for="set_intervall_time">Ausfuehrungsintervall:</label></td><td>';     // Default 60    echo '<input type="text" size="30px" id="set_intervall_time" name="set_intervall_time" value="60"></td></tr>';        echo '<tr><td><label for="set_prioritaet">Prioritaet:</label></td><td>';    // Default 20    echo '<input type="text" size="30px" id="set_prioritaet" name="set_prioritaet" value="20"></td></tr>';        echo "</table><br>";        echo '<label for="submit">&nbsp;</label>';    echo '<input type="submit" id="submit" name="submit" value="Job jetzt Erstellen" class="button" />';    echo '</form>';        echo "</td></tr></table>";};if ($step == "6") {    echo '<table border="0" width="100%">';    echo '<tr><td colspan="2">';    echo "<FONT SIZE=+2>Einrichtung eines neuen Daemon Jobs<br></font>";    echo "Schritt 5 von 5...<br><br>";    echo '</td></tr>';    echo '<tr><td valign="top">';    $sql_station_protokoll = "INSERT INTO `stationen_protokoll` (`stationen_ID`, `beschreibung`, `script`, `aktiv`, `sendcommand`, `receivefilter`, `recievecommand`, `parameter1`, `parameter2`, `parameter3`, `objektid`) VALUES (" . $set_stationid . ", '" . $set_beschreibung . "', '" . $set_script . "', '" . $set_aktiv . "', '" . $set_sendcommand . "', '" . $set_receivefilter . "', '" . $set_recievecommand . "', '" . $set_parameter1 . "', '" . $set_parameter2 . "', '" . $set_parameter3 . "', '" . $set_objektid . "')";    if (mysql_query($sql_station_protokoll, $link)) {            echo "Station Protokoll: Die Daten wurden erfolgreich in die Datenbank eingetragen.<br><br>";        $station_protokollid = mysql_insert_id();        //echo $station_protokollid;        $sql_queue = "INSERT INTO `queue` (`type`, `stationen_protokoll_ID`, `intervall_time`, `prioritaet`, `queue_lastrun_timestamp`) VALUES ('" . $set_type . "', '" . $station_protokollid . "', '" . $set_intervall_time . "', '" . $set_prioritaet . "', DATE_SUB(NOW(), INTERVAL 1 HOUR))";        if (mysql_query($sql_queue, $link)) {                echo "Queue: Die Daten wurden erfolgreich in die Datenbank eingetragen.<br><br>";            echo '<head><meta http-equiv="refresh" content="0;URL=index.php?' . session_name() . '=' . session_id() . '"></head>';        } else {            echo '<dl id="system-message"><dd class="message message fade error"><ul><li>Die Daten konnten nicht in die Datenbank geschrieben werden!</li><li>';            echo mysql_error($link); // Fehler Posten            echo "</li></ul></dd></dl>";        };    } else {        echo '<dl id="system-message"><dd class="message message fade error"><ul><li>Die Daten konnten nicht in die Datenbank geschrieben werden!</li><li>';        echo mysql_error($link); // Fehler Posten        echo "</li></ul></dd></dl>";    };    echo "</td></tr></table>";};include ("../../erw/ausgabe/copyright.php");?><?php} else {    $host  = htmlspecialchars($_SERVER["HTTP_HOST"]);    $uri   = rtrim(dirname(htmlspecialchars($_SERVER["PHP_SELF"])), "/\\");    $extra = "index.php";    header("Location: http://$host$uri/$extra");};?>